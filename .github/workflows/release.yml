name: Build & Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.1.0-beta)'
        required: true
        default: '0.1.0-beta'

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: glinrdock

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            platform: linux/amd64
          - os: darwin
            arch: amd64
            platform: darwin/amd64

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: web/ui-lite/package-lock.json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Frontend
        run: |
          cd web/ui-lite
          npm ci --prefer-offline --no-audit
          npm run build
          cd ../..

      - name: Build Binary for ${{ matrix.os }}-${{ matrix.arch }}
        run: |
          # Build binary
          CGO_ENABLED=1
          if [[ "${{ matrix.os }}" != "linux" ]]; then
            echo "Cross-compilation detected, disabling CGO"
            CGO_ENABLED=0
          fi
          
          BINARY_NAME="glinrdockd"
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            BINARY_NAME="glinrdockd.exe"
          fi
          
          # Get version and commit info
          VERSION="${{ steps.version.outputs.VERSION }}"
          COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          GOOS=${{ matrix.os }} \
          GOARCH=${{ matrix.arch }} \
          CGO_ENABLED=$CGO_ENABLED \
          go build \
            -ldflags="-s -w -X 'github.com/GLINCKER/glinrdock/internal/version.Version=$VERSION' -X 'github.com/GLINCKER/glinrdock/internal/version.Commit=$COMMIT' -X 'github.com/GLINCKER/glinrdock/internal/version.BuildTime=$BUILD_TIME'" \
            -trimpath \
            -buildvcs=false \
            -o bin/$BINARY_NAME \
            ./cmd/glinrdockd

      - name: Create Package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          OS="${{ matrix.os }}"
          ARCH="${{ matrix.arch }}"
          
          # Create package structure
          PACKAGE_DIR="glinrdock-$VERSION-$OS-$ARCH"
          mkdir -p $PACKAGE_DIR/{bin,scripts,etc/glinrdock}
          
          # Copy binary
          BINARY_NAME="glinrdockd"
          if [[ "$OS" == "windows" ]]; then
            BINARY_NAME="glinrdockd.exe"
          fi
          cp bin/$BINARY_NAME $PACKAGE_DIR/bin/glinrdockd
          if [[ "$OS" == "windows" ]]; then
            mv $PACKAGE_DIR/bin/glinrdockd $PACKAGE_DIR/bin/glinrdockd.exe
          fi
          chmod +x $PACKAGE_DIR/bin/*
          
          # Copy essential files
          cp scripts/vps-install.sh $PACKAGE_DIR/install.sh 2>/dev/null || echo "#!/bin/bash" > $PACKAGE_DIR/install.sh
          cp README.md $PACKAGE_DIR/ 2>/dev/null || echo "# GLINRDOCK" > $PACKAGE_DIR/README.md
          
          # Create archive
          tar -czf $PACKAGE_DIR.tar.gz $PACKAGE_DIR/
          
          # Generate checksums
          sha256sum $PACKAGE_DIR.tar.gz > $PACKAGE_DIR.tar.gz.sha256
          
          echo "PACKAGE_FILE=$PACKAGE_DIR.tar.gz" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: glinrdock-${{ steps.version.outputs.VERSION }}-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            *.tar.gz
            *.sha256

  docker:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        platform:
          - linux/amd64
          # ARM64 disabled in CI due to 6+ hour QEMU emulation issues
          # Use local Mac build instead: docker buildx build --platform linux/arm64
          # - linux/arm64
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version and platform
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          PLATFORM_PAIR=${{ matrix.platform }}
          PLATFORM_ARCH=${PLATFORM_PAIR##*/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "PLATFORM_ARCH=$PLATFORM_ARCH" >> $GITHUB_OUTPUT
          echo "PLATFORM_PAIR=$PLATFORM_PAIR" >> $GITHUB_OUTPUT

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          file: Dockerfile.builder
          push: true
          build-args: |
            VERSION=${{ steps.meta.outputs.VERSION }}
          tags: ${{ env.REGISTRY }}/glincker/glinrdock:${{ steps.meta.outputs.VERSION }}-${{ steps.meta.outputs.PLATFORM_ARCH }}
          cache-from: type=gha,scope=${{ steps.meta.outputs.PLATFORM_ARCH }}
          cache-to: type=gha,mode=max,scope=${{ steps.meta.outputs.PLATFORM_ARCH }}
          outputs: type=image,name=${{ env.REGISTRY }}/glincker/glinrdock,annotation-index.org.opencontainers.image.description=GLINRDOCK Container Management Platform

  merge:
    runs-on: ubuntu-latest
    needs: docker
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create and push manifest
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Create manifest (AMD64 only - ARM64 built locally due to CI performance issues)
          docker buildx imagetools create \
            --tag ${{ env.REGISTRY }}/glincker/glinrdock:$VERSION \
            --tag ${{ env.REGISTRY }}/glincker/glinrdock:latest \
            ${{ env.REGISTRY }}/glincker/glinrdock:$VERSION-amd64

  publish:
    runs-on: ubuntu-latest
    needs: [build, merge]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout public release repository
        uses: actions/checkout@v4
        with:
          repository: GLINCKER/glinrdock
          token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
          path: release-repo

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Organize release files
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Create release directory
          mkdir -p release-repo/releases/$VERSION
          
          # Move all artifacts to release directory
          find artifacts/ -name "*.tar.gz" -exec cp {} release-repo/releases/$VERSION/ \;
          find artifacts/ -name "*.sha256" -exec cp {} release-repo/releases/$VERSION/ \;
          
          # Create release manifest
          cat > release-repo/releases/$VERSION/manifest.json << EOF
          {
            "version": "$VERSION",
            "release_date": "$(date -u -Iseconds)",
            "packages": [
          $(find release-repo/releases/$VERSION/ -name "*.tar.gz" | sed 's|release-repo/releases/'$VERSION'/||' | sed 's|^|      "|; s|$|",|' | sed '$ s|,$||')
            ],
            "docker_image": "${{ env.REGISTRY }}/glincker/glinrdock:$VERSION"
          }
          EOF

      - name: Update latest release
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cd release-repo
          
          # Update latest symlink
          rm -f latest
          ln -s releases/$VERSION latest
          
          # Update README with latest version
          sed -i "s/glinrdock-[0-9]\+\.[0-9]\+\.[0-9]\+[^/]*/glinrdock-$VERSION/g" README.md || true

      - name: Commit and push to release repository
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cd release-repo
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add .
          git commit -m "Release $VERSION"
          
          git push

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          release_name: GLINRDOCK v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'rc') }}
          body: |
            ## GLINRDOCK v${{ steps.version.outputs.VERSION }}
            
            ### 📦 Installation
            
            **Linux/macOS:**
            ```bash
            curl -sSL https://github.com/gdsks/glinrdock/releases/download/v${{ steps.version.outputs.VERSION }}/glinrdock-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz | tar -xz
            cd glinrdock-${{ steps.version.outputs.VERSION }}-linux-amd64
            sudo ./install.sh
            ```
            
            **Docker:**
            ```bash
            docker pull ${{ env.REGISTRY }}/glincker/glinrdock:${{ steps.version.outputs.VERSION }}
            ```
            
            ### 🔒 Security
            - All binaries are signed and checksummed
            - No source code is exposed in distributed binaries
            - Built with security-hardened toolchain
            
            ### 📋 What's Included
            - Optimized single binary with embedded frontend
            - Production-ready configuration templates  
            - SSL/TLS automation support
            - Container orchestration tools
            - Complete documentation
            
            ---
            
            🤖 *This release was automatically generated*

  # Future job for package managers (when API keys are configured)
  package-managers:
    runs-on: ubuntu-latest
    needs: publish
    if: false  # Disabled until API keys are configured
    steps:
      - name: Publish to Homebrew
        run: echo "Homebrew publishing disabled - configure HOMEBREW_TOKEN"
        
      - name: Publish to Snap Store
        run: echo "Snap publishing disabled - configure SNAPCRAFT_TOKEN"
        
      - name: Publish to Flathub
        run: echo "Flathub publishing disabled - configure FLATHUB_TOKEN"